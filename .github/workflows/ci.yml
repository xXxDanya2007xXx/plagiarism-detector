name: CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  lint-and-structure:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        sudo apt-get install -y tree

    - name: Flake8 — Sanity check (fail-fast)
      run: |
        # Фатальные ошибки: синтаксис и критические дефекты (E9,F63,F7,F82).
        # При наличии ошибок сборка упадёт.
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Flake8 — Style report (non-blocking)
      run: |
        # Стиль/сложность/длина строк. Отчёт в логах, но сборку не ломаем.
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Pylint (Code Analysis)
      run: |
        # Анализируем папку src, если она существует и в ней есть .py файлы.
        if [ -d "src" ] && [ "$(ls -A src/*.py 2>/dev/null)" ]; then
          pylint src --fail-under=5.0
        else
          echo "No python files in src to analyze yet."
        fi

    - name: Generate Project Structure
      id: tree
      run: |
        # Генерируем дерево. Исключения упорядочены:
        tree -I '.git|.github|.venv|__pycache__|*.egg-info|*.pyc|tree_output.txt' -a -C --noreport . > tree_output.txt

        # Сохраняем результат для следующего шага.
        echo 'TREE_CONTENT<<EOF' >> $GITHUB_ENV
        cat tree_output.txt >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV

    - name: Update README.md
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const readmePath = 'README.md';
          const treeContent = process.env.TREE_CONTENT;

          if (fs.existsSync(readmePath)) {
            let content = fs.readFileSync(readmePath, 'utf8');

            const startMarker = '<!-- STRUCTURE_START -->';
            const endMarker = '<!-- STRUCTURE_END -->';

            // Формируем новый блок с деревом проекта.
            const newBlock = `${startMarker}\n\`\`\`text\n${treeContent}\n\`\`\`\n${endMarker}`;

            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`);

            if (content.match(regex)) {
              const newContent = content.replace(regex, newBlock);
              if (newContent !== content) {
                fs.writeFileSync(readmePath, newContent);
                console.log("README updated successfully.");
              } else {
                console.log("No changes in structure.");
              }
            } else {
              console.log("Markers not found in README. Add <!-- STRUCTURE_START --> and <!-- STRUCTURE_END -->");
            }
          }

    - name: Commit changes
      if: github.ref == 'refs/heads/main'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "docs: auto-update project structure in README.md"
        file_pattern: README.md
