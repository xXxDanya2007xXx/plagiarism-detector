name: Update README tree

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "docs/**"
      - "scripts/**"
      - "data/**"
      - "uploads/**"
      - ".github/workflows/**"
      - "pyproject.toml"
      - "requirements.txt"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tree:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tree
        run: |
          sudo apt-get update
          sudo apt-get install -y tree

      - name: Generate tree
        run: |
          tree -a -C --noreport \
            -I '.git|.venv|venv|__pycache__|*.egg-info|*.pyc|.pytest_cache|reports|site|tree_output.txt' \
            . > tree_output.txt

          echo 'TREE_CONTENT<<EOF' >> $GITHUB_ENV
          cat tree_output.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Patch README files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const treeContent = process.env.TREE_CONTENT;
            const startMarker = '<!-- STRUCTURE_START -->';
            const endMarker   = '<!-- STRUCTURE_END -->';
            const newBlock = `${startMarker}\n\`\`\`text\n${treeContent}\n\`\`\`\n${endMarker}`;
            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`, 'm');

            const targets = ['README.md', 'README.en.md'];

            for (const readmePath of targets) {
              if (!fs.existsSync(readmePath)) continue;
              const content = fs.readFileSync(readmePath, 'utf8');
              if (!content.includes(startMarker) || !content.includes(endMarker)) continue;

              const updated = content.replace(regex, newBlock);
              if (updated !== content) {
                fs.writeFileSync(readmePath, updated);
                console.log(`Updated: ${readmePath}`);
              } else {
                console.log(`No changes: ${readmePath}`);
              }
            }

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: auto-update project structure"
          file_pattern: "README.md README.en.md"
